<!--HTML file to test the iframe without having to launch the frontend
    Lets you see what the editor sent back to the server and send a
    custom feedback message back to the editor -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Iframe Test</title>
  <style>
    iframe {
      width: 690px;
      height: 30rem;
      border: none;
    }
  </style>
</head>
<body>
  <iframe src="http://localhost:3000" id="code-sandbox" onload="sendQuestion()"></iframe>
  <div id="submission">Waiting for submission...</div>
  <input id="feedback" value="Feedback message">
  <button onclick="sendCorrect()">Send correct</button>
  <button onclick="sendIncorrect()">Send incorrect</button>
  <script>
      // const initCode = "def square(x):\n  # Your code here",
      const initCode = "def square(x):\n  return x ** 2",
            test = "checkerResult = str([square(2), square(8), square(1), square(-3)])";

      let lastResponse;

      function sendPostMessage(obj) {
          const sandbox = document.getElementById("code-sandbox");
          sandbox.contentWindow.postMessage(obj, "*");
      }

      function sendQuestion() {
          sendPostMessage({
            type: "INIT",
              code: initCode,
              test: test
          });
      }

      function sendCorrect(message="") {
          sendPostMessage({
            type: "FEEDBACK",
            studentSucceeded: true,
            message: message || document.getElementById("feedback").value
          });
      }

      function sendIncorrect(message="") {
          sendPostMessage({
            type: "FEEDBACK",
            studentSucceeded: false,
            message: message || document.getElementById("feedback").value
          });
      }

      function checkLastResponse() {
          if(!lastResponse) return;

          if(lastResponse === "[4, 64, 1, 9]") sendCorrect();
          else sendIncorrect();

          /*let success = true;
          let message = "Congrats! You passed the test.";
          for (let i = 0; i < correct.length; i++) {
              if(lastResponse[i] !== correct[i]) {
                  message = `"square(${tests[i][0]})" returns ${lastResponse[i]} instead of ${correct[i]}!`;
                  success = false;
                  break;
              }
          }
          sendPostMessage({
              success: success,
              message: message
          });*/
      }

      window.addEventListener('message', e => {
        if (e.data.hasOwnProperty("checkerOutput")) {
          const feedbackDiv = document.getElementById("submission");
          lastResponse = e.data.checkerOutput;
          feedbackDiv.innerHTML = "Received response: " + e.data.checkerOutput + " <button onclick=\"checkLastResponse()\">Auto check</button>";
        }
      });
  </script>
</body>
</html>