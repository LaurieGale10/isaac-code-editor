<!--HTML file to test the iframe without having to launch the frontend
    Lets you see what the editor sent back to the server and send a
    custom feedback message back to the editor -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Iframe Test</title>
  <style>
    iframe {
      width: 690px;
      height: 30rem;
      border: none;
    }
  </style>
</head>
<body>
  <iframe src="http://localhost:3000" id="code-sandbox" onload="sendQuestion()"></iframe>
  <div id="submission">Waiting for submission...</div>
  <input id="feedback" value="Feedback message">
  <button onclick="sendCorrect()">Send correct</button>
  <button onclick="sendIncorrect()">Send incorrect</button>
  <script>
      const functionName = "square",
          question = "Create a function `square` that takes a parameter `x` and returns its square.",
          initCode = "def square(x):\n  # Your code here",
          tests = [[3], [5], [0], [-2]],
          correct = [9, 25, 0, 4];

      let lastResponse;

      function sendPostMessage(obj) {
          const sandbox = document.getElementById("code-sandbox");
          sandbox.contentWindow.postMessage(obj, "*");
      }

      function sendQuestion() {
          sendPostMessage({
              code: initCode,
              tests: tests,
              functionName: functionName
          });
      }

      function sendCorrect() {
          sendPostMessage({
              success: true,
              message: document.getElementById("feedback").value
          });
      }

      function sendIncorrect() {
          sendPostMessage({
              success: false,
              message: document.getElementById("feedback").value
          });
      }

      function checkLastResponse() {
          if(!lastResponse) return;

          let success = true;
          let message = "Congrats! You passed the test.";
          for (let i = 0; i < correct.length; i++) {
              if(lastResponse[i] !== correct[i]) {
                  message = `"square(${tests[i][0]})" returns ${lastResponse[i]} instead of ${correct[i]}!`;
                  success = false;
                  break;
              }
          }
          sendPostMessage({
              success: success,
              message: message
          });
      }

      window.addEventListener('message', e => {
          const feedbackDiv = document.getElementById("submission");
          lastResponse = e.data;
          feedbackDiv.innerHTML = "Received response: " + e.data + " <button onclick=\"checkLastResponse()\">Auto check</button>";
      });
  </script>
</body>
</html>